<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="keywords" content="masterserver-code-analysis">
  <meta name="description" content="masterserver-code-analysis">
  <title>masterserver-code-analysis</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/build/vendor.eeae4ed.css">
</head>
<body>
  <div id="root"><div class="md2html docs-page" data-reactroot=""><header class="header-container header-container-dark"><div class="banner-tips"><div>ğŸ¤” æœ‰å…³äº Apache DolphinScheduler çš„ç–‘é—®ï¼ŒåŠ å…¥ Slack é¢‘é“æ¥è®¨è®ºä»–ä»¬ <a class="link-tips" href="https://s.apache.org/dolphinscheduler-slack">join #dolphinscheduler channel</a>! ğŸŒŸ</div></div><div class="header-body"><span class="mobile-menu-btn mobile-menu-btn-dark"></span><a href="/zh-cn/index.html"><img class="logo" src="/img/hlogo_white.svg"/></a><div class="search search-dark"><span class="icon-search"></span></div><span class="language-switch language-switch-dark">En</span><div class="header-menu"><div><ul class="ant-menu whiteClass ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/index.html" target="_self">é¦–é¡µ</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-item-selected" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="/zh-cn/docs/latest/user_doc/about/introduction.html" target="_self">æ–‡æ¡£</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/download/download.html" target="_self">ä¸‹è½½</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/blog/index.html" target="_self">åšå®¢</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/development/development-environment-setup.html" target="_self">å¼€å‘è€…</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/community/team.html" target="_self">ç¤¾åŒº</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="https://www.apache.org/" target="_blank">ASF</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/zh-cn/user/index.html" target="_self">ç”¨æˆ·</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></div></div><div class="mobile-menu"><div class="mobile-menu-content"><div class="mobile-menu-list"><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/index.html" target="_self">é¦–é¡µ</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/docs/latest/user_doc/about/introduction.html" target="_self">æ–‡æ¡£</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="/zh-cn/docs/latest/user_doc/about/introduction.html" target="_self">æœ€æ–°ç‰ˆæœ¬latest(3.0.0-beta-1)</a></div><div class="mobile-sub-menu-item"><a href="/zh-cn/docs/1.3.9/user_doc/quick-start.html" target="_self">1.3.9</a></div><div class="mobile-sub-menu-item"><a href="/zh-cn/docs/release/history-versions.html" target="_self">å†å²ç‰ˆæœ¬</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/download/download.html" target="_self">ä¸‹è½½</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/blog/index.html" target="_self">åšå®¢</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/development/development-environment-setup.html" target="_self">å¼€å‘è€…</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/community/team.html" target="_self">ç¤¾åŒº</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="https://www.apache.org/" target="_blank">ASF</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="https://www.apache.org/" target="_blank">Foundation</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/licenses/" target="_blank">License</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/events/current-event" target="_blank">Events</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/security/" target="_blank">Security</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Sponsorship</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/zh-cn/user/index.html" target="_self">ç”¨æˆ·</a></div></div></div><div class="mobile-menu-dummy"></div></div></div></header><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>éƒ¨ç½²æ–‡æ¡£</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/hardware-environment.html" target="_self">è½¯ç¡¬ä»¶ç¯å¢ƒå»ºè®®é…ç½®</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/standalone-deployment.html" target="_self">å•æœºéƒ¨ç½²(Standalone)</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/cluster-deployment.html" target="_self">é›†ç¾¤éƒ¨ç½²(Cluster)</a></li></ul></li><li class="menu-item menu-item-level-1"><span>ç”¨æˆ·æ‰‹å†Œ</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/quick-start.html" target="_self">å¿«é€Ÿä¸Šæ‰‹</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/system-manual.html" target="_self">ç”¨æˆ·æ‰‹å†Œ</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/metadata-1.2.html" target="_self">å…ƒæ•°æ®æ–‡æ¡£</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/deployparam.html" target="_self">éƒ¨ç½²å‚æ•°åˆ†æ</a></li></ul></li><li class="menu-item menu-item-level-1"><span>ç‰ˆæœ¬å‡çº§</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/1.2.0/user_doc/upgrade.html" target="_self">å‡çº§</a></li></ul></li><li class="menu-item menu-item-level-1"><span>FAQ</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/release/faq.html" target="_self">FAQ</a></li></ul></li></ul></div><div class="doc-content markdown-body"><p>è¿™ä¸€ç¯‡ä¸»è¦è®²è§£çš„æ˜¯dolphinschedulerçš„masteréƒ¨åˆ†çš„æºç ï¼Œä»ä¸»ç±»MasterServerå¼€å§‹ï¼Œä»å¯åŠ¨åˆ°è¿è¡Œï¼Œmasterä¸»è¦åšäº†ä»¥ä¸‹ä¸‰ä»¶äº‹æƒ…</p>
<ul>
<li>Zookeeper èŠ‚ç‚¹åˆå§‹åŒ–</li>
<li>æ„å»ºå¹¶æäº¤å·¥ä½œæµå®ä¾‹ï¼Œè·Ÿè¸ªè¿è¡ŒçŠ¶æ€</li>
<li>ç›‘æ§å…¶ä»–MasterServerå’ŒWorkerServerçš„å¥åº·çŠ¶æ€å¹¶å®¹é”™</li>
<li>ç»´ç³»å¿ƒè·³</li>
</ul>
<pre><code>@PostConstruct
public void run(){
        //è¯¦æƒ…è§1.Zookeeperåˆå§‹åŒ–
        zkMasterClient.init(); 
        //è¯¦æƒ…è§2.MasterSchedulerThreadçº¿ç¨‹
        masterSchedulerService = ThreadUtils.newDaemonSingleThreadExecutor(&quot;Master-Scheduler-Thread&quot;);
        //è¯¦æƒ…è§3.heartBeatThreadçº¿ç¨‹
        heartbeatMasterService = ThreadUtils.newDaemonThreadScheduledExecutor(&quot;Master-Main-Thread&quot;,Constants.DEFAULT_MASTER_HEARTBEAT_THREAD_NUM);
}
</code></pre>
<h1>1. Zookeeperåˆå§‹åŒ–</h1>
<p>åˆ›å»ºDSåœ¨Zookeeperçš„ç›¸å…³èŠ‚ç‚¹ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å¯¹ç³»ç»Ÿåšfailoverï¼Œæ¢å¤å¼‚å¸¸çš„å·¥ä½œæµå®ä¾‹å’Œä»»åŠ¡å®ä¾‹ã€‚</p>
<ul>
<li>ç”¨äºmasterçš„failover /dolphinscheduler/lock/failover/master</li>
<li>ç³»ç»ŸèŠ‚ç‚¹ï¼Œä¿å­˜masterå’Œworkerçš„å¿ƒè·³ä¿¡æ¯ /dolphinscheduler/masters; /dolphinscheduler/workersï¼›/dolphinscheduler/dead-servers</li>
</ul>
<pre><code>public void init(){
	logger.info(&quot;initialize master client...&quot;);
	this.initDao();
	InterProcessMutex mutex = null;
	try {
	    //åˆ›å»ºåˆ†å¸ƒå¼é”èŠ‚ç‚¹ï¼Œç”¨äºmasterèŠ‚ç‚¹çš„failover 
		String znodeLock = getMasterStartUpLockPath();
		mutex = new InterProcessMutex(zkClient, znodeLock);
		mutex.acquire();
		// åœ¨ZKä¸­åˆå§‹åŒ–ç³»ç»ŸèŠ‚ç‚¹ï¼Œ
		this.initSystemZNode();
		// å‘ZKçš„/mastersèŠ‚ç‚¹æ³¨å†Œå½“å‰çš„masterä¿¡æ¯
		this.registerMaster();
		// é€šè¿‡ç›‘å¬Zookeeperä¸´æ—¶èŠ‚ç‚¹å˜åŒ–æ¥è¿›è¡Œå®¹é”™å¤„ç†ï¼ˆå¦‚æœæ´»è·ƒçš„masteråªæœ‰è‡ªèº«ä¸€ä¸ªï¼Œåˆ™è¿›è¡Œfailoverï¼‰
		if (getActiveMasterNum() == 1) { 
			failoverWorker(null, true);  //æ¢å¤ä»»åŠ¡å®ä¾‹ è¯¦æƒ…è§1.1.
			failoverMaster(null);   //æ¢å¤å·¥ä½œæµå®ä¾‹ è¯¦æƒ…è§1.2.
		}
	}catch (Exception e){
		logger.error(&quot;master start up  exception&quot;,e); 
	}finally {
		releaseMutex(mutex);
	}
}
</code></pre>
<h2>1.1. failoverWorker æ¢å¤ä»»åŠ¡å®ä¾‹</h2>
<pre><code>private void failoverWorker(String workerHost, boolean needCheckWorkerAlive) throws Exception {
   logger.info(&quot;start worker[{}] failover ...&quot;, workerHost);

   List&lt;TaskInstance&gt; needFailoverTaskInstanceList = processService.queryNeedFailoverTaskInstances(workerHost);
   for(TaskInstance taskInstance : needFailoverTaskInstanceList){
      if(needCheckWorkerAlive){
         if(!checkTaskInstanceNeedFailover(taskInstance)){
             //ä¸éœ€è¦failoverçš„ä¸¤ç§æƒ…å†µ
             // 1.ä»»åŠ¡è¯¦æƒ…ä¸­ä¸å­˜åœ¨hostä¿¡æ¯
             //2.ä»»åŠ¡åœ¨ZKä¸­å­˜åœ¨ï¼Œåˆ™åˆ¤æ–­å¯åŠ¨æ—¶é—´æ˜¯å¦å°äºworkerå¯åŠ¨æ—¶é—´ï¼Œå°äºåˆ™ä¸ç”¨failover
            continue;
               }
      }

      ProcessInstance instance = processService.findProcessInstanceDetailById(taskInstance.getProcessInstanceId());
      if(instance!=null){
         taskInstance.setProcessInstance(instance);
      }
      // å¦‚æœä»»åŠ¡ä¸­æœ‰yarnçš„ä»»åŠ¡åˆ™æ€æ‰ï¼Œkillçš„æ–¹å¼ï¼Œæ—¥å¿—ä¸­ç”¨æ­£åˆ™åŒ¹é…containIdçš„æ ¼å¼ï¼Œè·å–containIDï¼Œç”¨yarnå‘½ä»¤killã€‚
      ProcessUtils.killYarnJob(taskInstance);
      //æŠŠä»»åŠ¡çš„çŠ¶æ€ä»â€œrunningâ€æ”¹ä¸ºâ€œneed failoverâ€
      taskInstance.setState(ExecutionStatus.NEED_FAULT_TOLERANCE);
      processService.saveTaskInstance(taskInstance);
   }
   logger.info(&quot;end worker[{}] failover ...&quot;, workerHost);
}
</code></pre>
<h2>1.2. failoverMaster æ¢å¤å·¥ä½œæµå®ä¾‹</h2>
<pre><code>private void failoverMaster(String masterHost) {
   logger.info(&quot;start master failover ...&quot;);
  //è·å–éœ€è¦failoverçš„å·¥ä½œæµå®ä¾‹
   List&lt;ProcessInstance&gt; needFailoverProcessInstanceList = processService.queryNeedFailoverProcessInstances(masterHost);
   
   for(ProcessInstance processInstance : needFailoverProcessInstanceList){
       // 1.æ›´æ–°å·¥ä½œæµå®ä¾‹çš„hostä¸ºnull
       // 2.å†™å…¥ t_ds_commond è¡¨ä¸€æ¡æ¢å¤å·¥ä½œæµå®ä¾‹çš„å‘½ä»¤
      processService.processNeedFailoverProcessInstances(processInstance);
   }

   logger.info(&quot;master failover end&quot;);
}
</code></pre>
<h1>2. MasterSchedulerThread çº¿ç¨‹</h1>
<p>è¯¥çº¿ç¨‹ä¸»è¦å¯¹commandè¿›è¡Œè§£æç”Ÿæˆå·¥ä½œæµå®ä¾‹</p>
<pre><code>public void run() {
    logger.info(&quot;master scheduler start successfully...&quot;);
    while (Stopper.isRunning()){

        // process instance
        ProcessInstance processInstance = null;

        InterProcessMutex mutex = null;
        try {

            boolean runCheckFlag = OSUtils.checkResource(masterConfig.getMasterMaxCpuloadAvg(), masterConfig.getMasterReservedMemory());
            if(!runCheckFlag) {
                Thread.sleep(Constants.SLEEP_TIME_MILLIS);
                continue;
            }
            if (zkMasterClient.getZkClient().getState() == CuratorFrameworkState.STARTED) {

                //åˆ›å»ºåˆ†å¸ƒå¼é” /dolphinscheduler/lock/masters
                String znodeLock = zkMasterClient.getMasterLockPath();

                mutex = new InterProcessMutex(zkMasterClient.getZkClient(), znodeLock);
                mutex.acquire();

                ThreadPoolExecutor poolExecutor = (ThreadPoolExecutor) masterExecService;
                int activeCount = poolExecutor.getActiveCount();
                // éœ€è¦ç¡®ä¿å®ä¾‹æ„å»ºå­˜å‚¨è¿‡ç¨‹å’Œcommandæ•°æ®ä»è¡¨ä¸­åˆ é™¤çš„è¿‡ç¨‹åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
                Command command = processService.findOneCommand();
                if (command != null) {
                    logger.info(&quot;find one command: id: {}, type: {}&quot;, command.getId(),command.getCommandType());

                    try{
                        // handleCommandå°†commondè§£ææˆprocessInstance è¯¦æƒ…è§2.1
                        processInstance = processService.handleCommand(logger, OSUtils.getHost(), this.masterExecThreadNum - activeCount, command);
                        if (processInstance != null) {
                            logger.info(&quot;start master exec thread , split DAG ...&quot;);
                            // masterExecServiceï¼Œmasteræ‰§è¡Œçº¿ç¨‹ è¯¦æƒ…è§ 2.2
                            masterExecService.execute(new MasterExecThread(processInstance, processService));
                        }
                    }catch (Exception e){
                        logger.error(&quot;scan command error &quot;, e);
                        processService.moveToErrorCommand(command, e.toString());
                    }
                } else{
                    //indicate that no command ,sleep for 1s
                    Thread.sleep(Constants.SLEEP_TIME_MILLIS);
                }
            }
        }catch (Exception e){
            logger.error(&quot;master scheduler thread exception&quot;,e);
        }finally{
            AbstractZKClient.releaseMutex(mutex);
        }
    }
    logger.info(&quot;master server stopped...&quot;);
}
</code></pre>
<h2>2.1. handleCommand</h2>
<p>æ ¹æ®commandå¯¹è±¡æ„å»ºå·¥ä½œæµå®ä¾‹ï¼Œæ„å»ºåæŠŠè¯¥æ¡commandä»t_ds_commandè¡¨ä¸­åˆ é™¤ï¼Œéœ€è¦ç¡®ä¿çš„æ˜¯å®ä¾‹æ„å»ºå­˜å‚¨è¿‡ç¨‹å’Œcommandæ•°æ®ä»è¡¨ä¸­åˆ é™¤çš„è¿‡ç¨‹åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ã€‚</p>
<p>commandæ‰€æœ‰ç±»å‹å¦‚ä¸‹</p>
<ul>
<li>0 start a new process</li>
<li>1 start a new process from current nodes</li>
<li>2 recover tolerance fault process</li>
<li>3 recover suspended process</li>
<li>4 start process from failure task nodes</li>
<li>5 complement data</li>
<li>6 start a new process from scheduler</li>
<li>7 repeat running a process</li>
<li>8 pause a process</li>
<li>9 stop a process</li>
<li>10 recover waiting thread</li>
</ul>
<pre><code>@Transactional(rollbackFor = Exception.class)
public ProcessInstance handleCommand(Logger logger, String host, int validThreadNum, Command command) {
     //æ ¹æ®commandå‘½ä»¤ç”Ÿæˆæ–°çš„å·¥ä½œæµç¨‹å®ä¾‹
     ProcessInstance processInstance = constructProcessInstance(command, host);
    //cannot construct process instance, return null;
    if(processInstance == null){
        logger.error(&quot;scan command, command parameter is error: %s&quot;, command.toString());
        moveToErrorCommand(command, &quot;process instance is null&quot;);
        return null;
    }
    if(!checkThreadNum(command, validThreadNum)){
        logger.info(&quot;there is not enough thread for this command: {}&quot;,command.toString() );
        return setWaitingThreadProcess(command, processInstance);
    }
    processInstance.setCommandType(command.getCommandType());
    processInstance.addHistoryCmd(command.getCommandType());
    saveProcessInstance(processInstance);
    this.setSubProcessParam(processInstance);
    //ä¿å­˜äº†ä»»åŠ¡æµå®ä¾‹åå°†è¯¥å‘½ä»¤åˆ é™¤
    delCommandByid(command.getId());
    return processInstance;
}
</code></pre>
<h2>2.2. MasterExecThread æ‰§è¡Œçº¿ç¨‹</h2>
<pre><code>public void run() {
    ......

    try {
        //æ£€æŸ¥æ­¤è¿‡ç¨‹æ˜¯å¦æ˜¯è¡¥æ•° ä¸” æµç¨‹å®ä¾‹æ˜¯å¦ä¸ºå­æµç¨‹
        if (processInstance.isComplementData() &amp;&amp;  Flag.NO == processInstance.getIsSubProcess()){
            // è¯¦æƒ…è§2.2.2. æ‰§è¡Œè¡¥æ•°
            executeComplementProcess();  
        }else{
            //è¯¦æƒ…è§2.2.1. æ‰§è¡Œæµç¨‹å®ä¾‹
            executeProcess(); 
        }
    ......
}
</code></pre>
<h3>2.2.1. executeProcess() æ‰§è¡Œæµç¨‹å®ä¾‹</h3>
<pre><code>private void executeProcess() throws Exception {
    //1.æ ¹æ®æµç¨‹å®ä¾‹idæŸ¥æ‰¾æœ‰æ•ˆçš„ä»»åŠ¡åˆ—è¡¨ initTaskQueue()
    //2.æ„å»ºDAGå¤„ç†æµç¨‹ buildFlowDag() è¿”å›DAGå¯¹è±¡ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªä¿¡æ¯ï¼švertex ç‚¹ï¼Œå³ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹ï¼›edge è¾¹ï¼Œå³ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»
    prepareProcess();
    //æäº¤å¹¶ç›‘æ§ä»»åŠ¡ï¼Œç›´åˆ°å·¥ä½œæµåœæ­¢ è¯¦æƒ…è§2.2.1.1
    runProcess();
    //å½“çº¿ç¨‹æ± ä¸è¶³ä»¥ä¾›æµç¨‹å®ä¾‹ä½¿ç”¨æ—¶ï¼Œåˆ›å»ºæ¢å¤ç­‰å¾…çº¿ç¨‹å‘½ä»¤ã€‚
    //å­å·¥ä½œæµç¨‹å®ä¾‹æ— éœ€åˆ›å»ºæ¢å¤å‘½ä»¤ã€‚
    //åˆ›å»ºæ¢å¤ç­‰å¾…çº¿ç¨‹å‘½ä»¤å¹¶åŒæ—¶åˆ é™¤originå‘½ä»¤ã€‚
   //å¦‚æœå­˜åœ¨recoveryå‘½ä»¤ï¼Œåˆ™ä»…æ›´æ–°å­—æ®µupdate_time
    endProcess();
}
</code></pre>
<h4>2.2.1.1. runProcess()æäº¤å¹¶ç›‘æ§ä»»åŠ¡</h4>
<p>submitPostNodeæ–¹æ³•ä¼ å…¥çˆ¶ä»»åŠ¡èŠ‚ç‚¹çš„åå­—ï¼Œé€šè¿‡èŠ‚ç‚¹åï¼ŒDAGï¼Œè·å–ä»»åŠ¡èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¹¶ç”Ÿæˆä»»åŠ¡å®ä¾‹åˆ—è¡¨readyToSubmitTaskList</p>
<pre><code>private void runProcess(){
    submitPostNode(null);
</code></pre>
<p>submitStandByTask()æ–¹æ³•é‡Œé¢ä¼šéå†ä»»åŠ¡å®ä¾‹åˆ—è¡¨readyToSubmitTaskListï¼Œåˆ¤æ–­ä»»åŠ¡å®ä¾‹çš„ä¾èµ–å…³ç³»ï¼Œä¾èµ–é¡¹è¿è¡ŒæˆåŠŸåˆ™ä¼šæäº¤ä»»åŠ¡æ‰§è¡Œçº¿ç¨‹ï¼Œå¤±è´¥åˆ™æŠŠå½“å‰èŠ‚ç‚¹çŠ¶æ€æ”¹ä¸ºå¤±è´¥ã€‚</p>
<pre><code>
       if(canSubmitTaskToQueue()){
           submitStandByTask();
       }
       try {
           Thread.sleep(Constants.SLEEP_TIME_MILLIS);
       } catch (InterruptedException e) {
           logger.error(e.getMessage(),e);
       }
       updateProcessInstanceState();
   }

   logger.info(&quot;process:{} end, state :{}&quot;, processInstance.getId(), processInstance.getState());
}
</code></pre>
<p>submitStandByTask()æœ€ç»ˆä¼šè°ƒç”¨submitTaskExecï¼Œè¿™é‡Œæœ‰ä¸ªMasterBaseTaskExecThreadçº¿ç¨‹
MasterBaseTaskExecThreadçº¿ç¨‹æœ‰ä¸¤ä¸ªä¸»è¦ä½œç”¨</p>
<ul>
<li>ç”¨äºæŠŠä»»åŠ¡å®ä¾‹ä¿¡æ¯æäº¤åˆ°æ•°æ®åº“ä¸­submitTask()</li>
<li>æŠŠä»»åŠ¡ä¿¡æ¯å†™è¿›Zookeeperé˜Ÿåˆ— submitTaskToQueue()ï¼Œåç»­workerä¼šæ¥è®¤é¢†ä»»åŠ¡ã€‚ï¼ˆèŠ‚ç‚¹å‘½åæ–¹å¼ï¼š{processInstancePriority}_{processInstanceId}<em>{taskInstancePriority}_{taskInstanceId}</em><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi>t</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>x</mi><mi>e</mi><mi>c</mi><mi>u</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>b</mi><mi>y</mi><mi>i</mi><mi>p</mi><mn>1</mn></mrow><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">{task executed by ip1},</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathit">t</span><span class="mord mathit">a</span><span class="mord mathit">s</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mord mathit">e</span><span class="mord mathit">x</span><span class="mord mathit">e</span><span class="mord mathit">c</span><span class="mord mathit">u</span><span class="mord mathit">t</span><span class="mord mathit">e</span><span class="mord mathit">d</span><span class="mord mathit">b</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathit">i</span><span class="mord mathit">p</span><span class="mord mathrm">1</span></span><span class="mpunct">,</span></span></span></span>{ip2}...ï¼‰</li>
</ul>
<p>å¦å¤–MasterBaseTaskExecThreadæœ‰ä¸¤ä¸ªå­ç±»ï¼Œé™¤äº†ä¸Šé¢çš„ä¸¤ä¸ªä½œç”¨å¤–ï¼š</p>
<ul>
<li>MasterTaskExecThread ä»»åŠ¡æ‰§è¡Œå®Œæˆåä¼šæŠŠéœ€è¦killçš„ä»»åŠ¡ä¿¡æ¯å†™å…¥zké˜Ÿåˆ—ä¸­ç­‰å¾…workeræ¥killä»»åŠ¡ã€‚</li>
<li>SubProcessTaskExecThread åœ¨å½“å‰å·¥ä½œæµè¿è¡Œç»“æŸåä¼šç»§ç»­è¿è¡Œå­å·¥ä½œæµå¹¶åšç›¸å…³çŠ¶æ€æ›´æ–°ï¼Œå­å·¥ä½œæµå®Œå…¨å®Œæˆæ‰åŒæ­¥çŠ¶æ€ä¸ºå­å·¥ä½œæµçš„çŠ¶æ€ã€‚</li>
</ul>
<p>MasterBaseTaskExecThreadçº¿ç¨‹å¼‚æ­¥æäº¤ï¼Œä¼šæŠŠç»“æœå†™å…¥activeTaskNodeã€‚</p>
<pre><code>    private TaskInstance submitTaskExec(TaskInstance taskInstance) {
        MasterBaseTaskExecThread abstractExecThread = null;
        if(taskInstance.isSubProcess()){
            abstractExecThread = new SubProcessTaskExecThread(taskInstance, processInstance);
        }else {
            abstractExecThread = new MasterTaskExecThread(taskInstance, processInstance);
        }
        Future&lt;Boolean&gt; future = taskExecService.submit(abstractExecThread);
        activeTaskNode.putIfAbsent(abstractExecThread, future);
        return abstractExecThread.getTaskInstance();
    }
</code></pre>
<p>ç„¶åä¼šéå†activeTaskNodeï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œè‹¥å®Œæˆåˆ™ç§»é™¤è¯¥çº¿ç¨‹ä¿¡æ¯ï¼Œå†åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</p>
<pre><code>   for(Map.Entry&lt;MasterBaseTaskExecThread,Future&lt;Boolean&gt;&gt; entry: activeTaskNode.entrySet()) {
                Future&lt;Boolean&gt; future = entry.getValue();
                TaskInstance task  = entry.getKey().getTaskInstance();

                if(!future.isDone()){
                    continue;
                }
                // node monitor thread complete
                activeTaskNode.remove(entry.getKey());
                if(task == null){
                    this.taskFailedSubmit = true;
                    continue;
                }
                logger.info(&quot;task :{}, id:{} complete, state is {} &quot;,
                        task.getName(), task.getId(), task.getState().toString());
                // å¦‚æœèŠ‚ç‚¹æˆåŠŸï¼Œåˆ™ç»§ç»­æäº¤ä»»åŠ¡èŠ‚ç‚¹
                if(task.getState() == ExecutionStatus.SUCCESS){
                    completeTaskList.put(task.getName(), task);
                    submitPostNode(task.getName());
                    continue;
                }
                // å¦‚æœèŠ‚ç‚¹å¤±è´¥ï¼Œå…ˆé‡è¯•ï¼Œç„¶åå†ç»§ç»­æ‰§è¡Œå¤±è´¥æµç¨‹
                if(task.getState().typeIsFailure()){
                    if(task.getState() == ExecutionStatus.NEED_FAULT_TOLERANCE){
                        this.recoverToleranceFaultTaskList.add(task);
                    }
                    if(task.taskCanRetry()){
                        addTaskToStandByList(task);
                    }else{
                        completeTaskList.put(task.getName(), task);
                        if( task.getTaskType().equals(TaskType.CONDITIONS.toString()) ||
                                haveConditionsAfterNode(task.getName())) {
                            submitPostNode(task.getName());
                        }else{
                            errorTaskList.put(task.getName(), task);
                            if(processInstance.getFailureStrategy() == FailureStrategy.END){
                                killTheOtherTasks();
                            }
                        }
                    }
                    continue;
                }
                // other status stop/pause
                completeTaskList.put(task.getName(), task);
            }
            // send alert
</code></pre>
<h3>2.2.2. executeComplementProcess() æ‰§è¡Œè¡¥æ•°æµç¨‹å®ä¾‹</h3>
<pre><code>private void executeComplementProcess() throws Exception {
....
//æ ¹æ®è°ƒåº¦çš„æ—¶é—´è§„åˆ™å’Œè¡¥æ•°çš„æ—¶é—´èŒƒå›´è®¡ç®—å‡ºéœ€è¦è¡¥æ•°çš„æ—¥æœŸåˆ—è¡¨
int processDefinitionId = processInstance.getProcessDefinitionId();
List&lt;Schedule&gt; schedules = processService.queryReleaseSchedulerListByProcessDefinitionId(processDefinitionId);
List&lt;Date&gt; listDate = Lists.newLinkedList();
if(!CollectionUtils.isEmpty(schedules)){
    for (Schedule schedule : schedules) {
        listDate.addAll(CronUtils.getSelfFireDateList(startDate, endDate, schedule.getCrontab()));
    }
}
//æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œç”¨æ—¥æœŸåˆ—è¡¨çš„æ¯ä¸ªæ—¥æœŸæ‰§è¡Œä¸€æ¬¡
//ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•åŒ 2.2.1
....
prepareProcess();
....
runProcess();
....
endProcess();
</code></pre>
<h1>3. heartBeatThreadçº¿ç¨‹</h1>
<p>æ¯30ç§’ä¸ŠæŠ¥ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯ï¼Œ
åŒæ—¶åˆ¤æ–­hostæ˜¯å¦åœ¨dead-serversèŠ‚ç‚¹ä¸‹ï¼Œå³åˆ¤æ–­è¿›ç¨‹æ˜¯å¦å·²ç»æŒ‚äº†ã€‚
è¿›ç¨‹æ­£å¸¸åˆ™æ›´æ–°Zookeeperçš„/dolphinscheduler/masters/${host}/ ä¸‹çš„èŠ‚ç‚¹åç§°ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯
ip, port ,cpUsage, memoryUsage, loadAverage, registerTIme, currentTime</p>
<pre><code>    private Runnable heartBeatThread(){
        logger.info(&quot;start master heart beat thread...&quot;);
        Runnable heartBeatThread  = new Runnable() {
            @Override
            public void run() {
                if(Stopper.isRunning()) {
                    // send heartbeat to zk
                    if (StringUtils.isBlank(zkMasterClient.getMasterZNode())) {
                        logger.error(&quot;master send heartbeat to zk failed: can't find Zookeeper path of master server&quot;);
                        return;
                    }

                    zkMasterClient.heartBeatForZk(zkMasterClient.getMasterZNode(), Constants.MASTER_PREFIX);
                }
            }
        };
        return heartBeatThread;
    }
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><div><h3>è”ç³»æˆ‘ä»¬</h3><h4>æœ‰é—®é¢˜éœ€è¦åé¦ˆï¼Ÿè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ã€‚</h4></div><div class="contact-container"><ul><li><a href="/zh-cn/community/development/subscribe.html"><img class="img-base" src="/img/emailgray.png"/><img class="img-change" src="/img/emailblue.png"/><p>é‚®ä»¶åˆ—è¡¨</p></a></li><li><a href="https://twitter.com/dolphinschedule"><img class="img-base" src="/img/twittergray.png"/><img class="img-change" src="/img/twitterblue.png"/><p>Twitter</p></a></li><li><a href="https://stackoverflow.com/questions/tagged/apache-dolphinscheduler"><img class="img-base" src="/img/stackoverflow.png"/><img class="img-change" src="/img/stackoverflow-selected.png"/><p>Stack Overflow</p></a></li><li><a href="https://s.apache.org/dolphinscheduler-slack"><img class="img-base" src="/img/slack.png"/><img class="img-change" src="/img/slack-selected.png"/><p>Slack</p></a></li></ul></div><div class="cols-container"><div class="docu-container"><h4>æ–‡æ¡£</h4><ul><li><a href="/zh-cn/development/architecture-design.html"><p>æ¦‚è§ˆ</p></a></li><li><a href="/zh-cn/docs/latest/user_doc/guide/quick-start.html"><p>å¿«é€Ÿå¼€å§‹</p></a></li><li><a href="/zh-cn/development/development-environment-setup.html"><p>å¼€å‘è€…æŒ‡å—</p></a></li></ul></div><div></div><div class="asf-container"><h4>ASF</h4><ul><li><a href="http://www.apache.org"><p>åŸºé‡‘ä¼š</p></a></li><li><a href="http://www.apache.org/licenses/"><p>è¯ä¹¦</p></a></li><li><a href="http://www.apache.org/events/current-event"><p>äº‹ä»¶</p></a></li><li><a href="http://www.apache.org/foundation/sponsorship.html"><p>èµåŠ©</p></a></li><li><a href="http://www.apache.org/foundation/thanks.html"><p>è‡´è°¢</p></a></li></ul></div></div><div class="copyright"><span>Copyright Â© 2019-2021 The Apache Software Foundation. Apache DolphinScheduler, DolphinScheduler, and its feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
  <script src="/asset/js/react/react-with-addons.min.js"></script>
  <script src="/asset/js/react/react-dom.min.js"></script>
  <script>window.rootPath = '';</script>
  <script src="/build/vendor.c93d83b.js"></script>
  <script src="/build/docs.md.000d526.js"></script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6bc736fd9885d9a5dc938425ac062ad";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-899J8PYKJZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-899J8PYKJZ');
  </script>
</body>
</html>