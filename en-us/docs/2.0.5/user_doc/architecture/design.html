<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="keywords" content="design">
  <meta name="description" content="design">
  <title>design</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/build/vendor.eeae4ed.css">
</head>
<body>
  <div id="root"><div class="md2html docs-page" data-reactroot=""><header class="header-container header-container-dark"><div class="banner-tips"><div>🤔 Have queries regarding Apache DolphinScheduler, Join Slack channel to disscuss them <a class="link-tips" href="https://s.apache.org/dolphinscheduler-slack">join #dolphinscheduler channel</a>! 🌟</div></div><div class="header-body"><span class="mobile-menu-btn mobile-menu-btn-dark"></span><a href="/en-us/index.html"><img class="logo" src="/img/hlogo_white.svg"/></a><div class="search search-dark"><span class="icon-search"></span></div><span class="language-switch language-switch-dark">中</span><div class="header-menu"><div><ul class="ant-menu whiteClass ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/index.html" target="_self">HOME</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-item-selected" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">DOCS</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/download/download.html" target="_self">DOWNLOAD</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/blog/index.html" target="_self">BLOG</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/development/development-environment-setup.html" target="_self">DEVELOPMENT</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/community/team.html" target="_self">COMMUNITY</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="https://www.apache.org/" target="_blank">ASF</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/user/index.html" target="_self">USER</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></div></div><div class="mobile-menu"><div class="mobile-menu-content"><div class="mobile-menu-list"><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/index.html" target="_self">HOME</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">DOCS</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">latest(3.0.0-beta-2)</a></div><div class="mobile-sub-menu-item"><a href="/en-us/docs/2.0.6/user_doc/guide/quick-start.html" target="_self">2.0.6</a></div><div class="mobile-sub-menu-item"><a href="/en-us/docs/release/history-versions.html" target="_self">Older Versions</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/download/download.html" target="_self">DOWNLOAD</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/blog/index.html" target="_self">BLOG</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/development/development-environment-setup.html" target="_self">DEVELOPMENT</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/community/team.html" target="_self">COMMUNITY</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="https://www.apache.org/" target="_blank">ASF</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="https://www.apache.org/" target="_blank">Foundation</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/licenses/" target="_blank">License</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/events/current-event" target="_blank">Events</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/security/" target="_blank">Security</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Sponsorship</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/user/index.html" target="_self">USER</a></div></div></div><div class="mobile-menu-dummy"></div></div></div></header><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>About</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/About_DolphinScheduler/About_DolphinScheduler.html" target="_self">Introduction</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/hardware.html" target="_self">Hardware Environment</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/designplus.html" target="_self">Glossary</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Quick Start</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/quick-start.html" target="_self">Quick Start</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/docker.html" target="_self">Docker Deployment</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Installation</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/standalone.html" target="_self">Standalone Deployment</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/pseudo-cluster.html" target="_self">Pseudo Cluster Deployment</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/cluster.html" target="_self">Cluster Deployment</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/installation/kubernetes.html" target="_self">Kubernetes Deployment</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Introduction to Functions</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/homepage.html" target="_self">Workflow Overview</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Project<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/project/project-list.html" target="_self">Project List</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/project/workflow-definition.html" target="_self">Workflow Definition</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/project/workflow-instance.html" target="_self">Workflow Instance</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/project/task-instance.html" target="_self">Task Instance</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Task<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/shell.html" target="_self">Shell</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/sub-process.html" target="_self">SubProcess</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/dependent.html" target="_self">Dependent</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/stored-procedure.html" target="_self">Stored Procedure</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/sql.html" target="_self">SQL</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/spark.html" target="_self">Spark</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/map-reduce.html" target="_self">MapReduce</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/python.html" target="_self">Python</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/flink.html" target="_self">Flink</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/http.html" target="_self">HTTP</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/datax.html" target="_self">DataX</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/pigeon.html" target="_self">Pigeon</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/conditions.html" target="_self">Conditions</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/task/switch.html" target="_self">Switch</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Parameter<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/parameter/built-in.html" target="_self">Built-in Parameter</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/parameter/global.html" target="_self">Global Parameter</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/parameter/local.html" target="_self">Local Parameter</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/parameter/context.html" target="_self">Parameter Context</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/parameter/priority.html" target="_self">Parameter Priority</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Data Source<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/datasource/introduction.html" target="_self">Introduction</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/datasource/mysql.html" target="_self">MySQL</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/datasource/postgresql.html" target="_self">PostgreSQL</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/datasource/hive.html" target="_self">HIVE</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/datasource/spark.html" target="_self">Spark</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Alert<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/alert/alert_plugin_user_guide.html" target="_self">Alert Component User Guide </a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/alert/enterprise-wechat.html" target="_self">Enterprise Wechat</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/2.0.5/user_doc/guide/alert/dingtalk.html" target="_self">Ding Talk</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/resource.html" target="_self">Resource</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/monitor.html" target="_self">Monitor</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/security.html" target="_self">Security</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/open-api.html" target="_self">Open API</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/flink-call.html" target="_self">Flink</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/upgrade.html" target="_self">Upgrade</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/expansion-reduction.html" target="_self">Expansion and Reduction</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Advanced Guide</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/design.html" target="_self">Architecture Design</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/metadata.html" target="_self">Metadata</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/configuration.html" target="_self">Configuration File</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/task-structure.html" target="_self">Task Structure</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/load-balance.html" target="_self">Load Balance</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/architecture/cache.html" target="_self">Cache</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Observability</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/2.0.5/user_doc/guide/observability/skywalking-agent.html" target="_self">SkyWalking-Agent</a></li></ul></li><li class="menu-item menu-item-level-1"><span>FAQ</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/release/faq.html" target="_self">FAQ</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Older Versions</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/release/history-versions.html" target="_self">Older Versions</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h2>System Architecture Design</h2>
<p>Before explaining the architecture of the scheduling system, let's first understand the commonly used terms of the
scheduling system</p>
<h3>1.System Structure</h3>
<h4>1.1 System architecture diagram</h4>
<p align="center">
  <img src="/img/architecture-1.3.0.jpg" alt="System architecture diagram"  width="70%" />
  <p align="center">
        <em>System architecture diagram</em>
  </p>
</p>
<h4>1.2 Start process activity diagram</h4>
<p align="center">
  <img src="/img/master-process-2.0-en.png" alt="Start process activity diagram"  width="70%" />
  <p align="center">
        <em>Start process activity diagram</em>
  </p>
</p>
<h4>1.3 Architecture description</h4>
<ul>
<li>
<p><strong>MasterServer</strong></p>
<p>MasterServer adopts a distributed and centerless design concept. MasterServer is mainly responsible for DAG task
segmentation, task submission monitoring, and monitoring the health status of other MasterServer and WorkerServer at
the same time. When the MasterServer service starts, register a temporary node with Zookeeper, and perform fault
tolerance by monitoring changes in the temporary node of Zookeeper. MasterServer provides monitoring services based on
netty.</p>
<h5>The service mainly includes:</h5>
<ul>
<li>
<p><strong>MasterSchedulerService</strong> is a scanning thread that scans the <strong>command</strong> table in the database regularly,
generates workflow instances, and performs different business operations according to different <strong>command types</strong></p>
</li>
<li>
<p><strong>WorkflowExecuteThread</strong> is mainly responsible for DAG task segmentation, task submission, logical processing of
various command types, processing task status and workflow status events</p>
</li>
<li>
<p><strong>EventExecuteService</strong> handles all state change events of the workflow instance that the master is responsible
for, and uses the thread pool to process the state events of the workflow</p>
</li>
<li>
<p><strong>StateWheelExecuteThread</strong> handles timing state updates of dependent tasks and timeout tasks</p>
</li>
</ul>
</li>
<li>
<p><strong>WorkerServer</strong></p>
<pre><code>WorkerServer also adopts a distributed centerless design concept, supports custom task plug-ins, and is mainly responsible for task execution and log services.
When the WorkerServer service starts, it registers a temporary node with Zookeeper and maintains a heartbeat.
</code></pre>
</li>
</ul>
<h5>The service mainly includes</h5>
<pre><code>- **WorkerManagerThread** mainly receives tasks sent by the master through netty, and calls **TaskExecuteThread** corresponding executors according to different task types.
 
- **RetryReportTaskStatusThread** mainly reports the task status to the master through netty. If the report fails, the report will always be retried.

- **LoggerServer** is a log service that provides log fragment viewing, refreshing and downloading functions
</code></pre>
<ul>
<li>
<p><strong>Registry</strong></p>
<p>The registry is implemented as a plug-in, and Zookeeper is supported by default. The MasterServer and WorkerServer
nodes in the system use the registry for cluster management and fault tolerance. In addition, the system also performs
event monitoring and distributed locks based on the registry.</p>
</li>
<li>
<p><strong>Alert</strong></p>
<p>Provide alarm-related functions and only support stand-alone service. Support custom alarm plug-ins.</p>
</li>
<li>
<p><strong>API</strong></p>
<p>The API interface layer is mainly responsible for processing requests from the front-end UI layer. The service
uniformly provides RESTful APIs to provide request services to the outside world. Interfaces include workflow
creation, definition, query, modification, release, logoff, manual start, stop, pause, resume, start execution from
the node and so on.</p>
</li>
<li>
<p><strong>UI</strong></p>
<p>The front-end page of the system provides various visual operation interfaces of the system,See more
at <a href="../guide/homepage.md">Introduction to Functions</a> section。</p>
</li>
</ul>
<h4>1.4 Architecture design ideas</h4>
<h5>One、Decentralization VS centralization</h5>
<h6>Centralized thinking</h6>
<p>The centralized design concept is relatively simple. The nodes in the distributed cluster are divided into roles
according to roles, which are roughly divided into two roles:</p>
<p align="center">
   <img src="https://analysys.github.io/easyscheduler_docs_cn/images/master_slave.png" alt="master-slave character"  width="50%" />
 </p>
<ul>
<li>The role of the master is mainly responsible for task distribution and monitoring the health status of the slave, and
can dynamically balance the task to the slave, so that the slave node will not be in a &quot;busy dead&quot; or &quot;idle dead&quot;
state.</li>
<li>The role of Worker is mainly responsible for task execution and maintenance and Master's heartbeat, so that Master can
assign tasks to Slave.</li>
</ul>
<p>Problems in centralized thought design:</p>
<ul>
<li>Once there is a problem with the Master, the dragons are headless and the entire cluster will collapse. In order to
solve this problem, most of the Master/Slave architecture models adopt the design scheme of active and standby Master,
which can be hot standby or cold standby, or automatic switching or manual switching, and more and more new systems
are beginning to have The ability to automatically elect and switch Master to improve the availability of the system.</li>
<li>Another problem is that if the Scheduler is on the Master, although it can support different tasks in a DAG running on
different machines, it will cause the Master to be overloaded. If the Scheduler is on the slave, all tasks in a DAG
can only submit jobs on a certain machine. When there are more parallel tasks, the pressure on the slave may be
greater.</li>
</ul>
<h6>Decentralized</h6>
 <p align="center">
   <img src="https://analysys.github.io/easyscheduler_docs_cn/images/decentralization.png" alt="Decentralization"  width="50%" />
 </p>
<ul>
<li>
<p>In the decentralized design, there is usually no concept of Master/Slave, all roles are the same, the status is equal,
the global Internet is a typical decentralized distributed system, any node equipment connected to the network is
down, All will only affect a small range of functions.</p>
</li>
<li>
<p>The core design of decentralized design is that there is no &quot;manager&quot; different from other nodes in the entire
distributed system, so there is no single point of failure. However, because there is no &quot;manager&quot; node, each node
needs to communicate with other nodes to obtain the necessary machine information, and the unreliability of
distributed system communication greatly increases the difficulty of implementing the above functions.</p>
</li>
<li>
<p>In fact, truly decentralized distributed systems are rare. Instead, dynamic centralized distributed systems are
constantly pouring out. Under this architecture, the managers in the cluster are dynamically selected, rather than
preset, and when the cluster fails, the nodes of the cluster will automatically hold &quot;meetings&quot; to elect new &quot;
managers&quot; To preside over the work. The most typical case is Etcd implemented by ZooKeeper and Go language.</p>
</li>
<li>
<p>The decentralization of DolphinScheduler is that the Master/Worker is registered in Zookeeper to realize the
non-centralization of the Master cluster and the Worker cluster. The sharding mechanism is used to fairly distribute
the workflow for execution on the master, and tasks are sent to the workers for execution through different sending
strategies. Specific task</p>
</li>
</ul>
<h5>Second, the master execution process</h5>
<ol>
<li>
<p>DolphinScheduler uses the sharding algorithm to modulate the command and assigns it according to the sort id of the
master. The master converts the received command into a workflow instance, and uses the thread pool to process the
workflow instance</p>
</li>
<li>
<p>DolphinScheduler's process of workflow:</p>
</li>
</ol>
<ul>
<li>Start the workflow through UI or API calls, and persist a command to the database</li>
<li>The Master scans the Command table through the sharding algorithm, generates a workflow instance ProcessInstance, and
deletes the Command data at the same time</li>
<li>The Master uses the thread pool to run WorkflowExecuteThread to execute the process of the workflow instance,
including building DAG, creating task instance TaskInstance, and sending TaskInstance to worker through netty</li>
<li>After the worker receives the task, it modifies the task status and returns the execution information to the Master</li>
<li>The Master receives the task information, persists it to the database, and stores the state change event in the
EventExecuteService event queue</li>
<li>EventExecuteService calls WorkflowExecuteThread according to the event queue to submit subsequent tasks and modify
workflow status</li>
</ul>
<h5>Three、Insufficient thread loop waiting problem</h5>
<ul>
<li>If there is no sub-process in a DAG, if the number of data in the Command is greater than the threshold set by the
thread pool, the process directly waits or fails.</li>
<li>If many sub-processes are nested in a large DAG, the following figure will produce a &quot;dead&quot; state:</li>
</ul>
 <p align="center">
   <img src="https://analysys.github.io/easyscheduler_docs_cn/images/lack_thread.png" alt="Insufficient threads waiting loop problem"  width="50%" />
 </p>
In the above figure, MainFlowThread waits for the end of SubFlowThread1, SubFlowThread1 waits for the end of SubFlowThread2, SubFlowThread2 waits for the end of SubFlowThread3, and SubFlowThread3 waits for a new thread in the thread pool, then the entire DAG process cannot end, so that the threads cannot be released. In this way, the state of the child-parent process loop waiting is formed. At this time, unless a new Master is started to add threads to break such a "stalemate", the scheduling cluster will no longer be used.
<p>It seems a bit unsatisfactory to start a new Master to break the deadlock, so we proposed the following three solutions
to reduce this risk:</p>
<ol>
<li>Calculate the sum of all Master threads, and then calculate the number of threads required for each DAG, that is,
pre-calculate before the DAG process is executed. Because it is a multi-master thread pool, the total number of
threads is unlikely to be obtained in real time.</li>
<li>Judge the single-master thread pool. If the thread pool is full, let the thread fail directly.</li>
<li>Add a Command type with insufficient resources. If the thread pool is insufficient, suspend the main process. In this
way, there are new threads in the thread pool, which can make the process suspended by insufficient resources wake up
to execute again.</li>
</ol>
<p>note: The Master Scheduler thread is executed by FIFO when acquiring the Command.</p>
<p>So we chose the third way to solve the problem of insufficient threads.</p>
<h5>Four、Fault-tolerant design</h5>
<p>Fault tolerance is divided into service downtime fault tolerance and task retry, and service downtime fault tolerance is
divided into master fault tolerance and worker fault tolerance.</p>
<h6>1. Downtime fault tolerance</h6>
<p>The service fault-tolerance design relies on ZooKeeper's Watcher mechanism, and the implementation principle is shown in the figure:</p>
 <p align="center">
   <img src="https://analysys.github.io/easyscheduler_docs_cn/images/fault-tolerant.png" alt="DolphinScheduler fault-tolerant design"  width="40%" />
 </p>
Among them, the Master monitors the directories of other Masters and Workers. If the remove event is heard, fault tolerance of the process instance or task instance will be performed according to the specific business logic.
<ul>
<li>Master fault tolerance：</li>
</ul>
<p align="center">
   <img src="/img/failover-master.jpg" alt="failover-master"  width="50%" />
 </p>
<p>Fault tolerance range: From the perspective of host, the fault tolerance range of Master includes: own host + node host that does not exist in the registry, and the entire process of fault tolerance will be locked;</p>
<p>Fault-tolerant content: Master's fault-tolerant content includes: fault-tolerant process instances and task instances. Before fault-tolerant, it compares the start time of the instance with the server start-up time, and skips fault-tolerance if after the server start time;</p>
<p>Fault-tolerant post-processing: After the fault tolerance of ZooKeeper Master is completed, it is re-scheduled by the Scheduler thread in DolphinScheduler, traverses the DAG to find the &quot;running&quot; and &quot;submit successful&quot; tasks, monitors the status of its task instances for the &quot;running&quot; tasks, and &quot;commits successful&quot; tasks It is necessary to determine whether the task queue already exists. If it exists, the status of the task instance is also monitored. If it does not exist, resubmit the task instance.</p>
<ul>
<li>Worker fault tolerance：</li>
</ul>
<p align="center">
   <img src="/img/failover-worker.jpg" alt="failover-worker"  width="50%" />
 </p>
<p>Fault tolerance range: From the perspective of process instance, each Master is only responsible for fault tolerance of its own process instance; it will lock only when <code>handleDeadServer</code>;</p>
<p>Fault-tolerant content: When sending the remove event of the Worker node, the Master only fault-tolerant task instances. Before fault-tolerant, it compares the start time of the instance with the server start-up time, and skips fault-tolerance if after the server start time;</p>
<p>Fault-tolerant post-processing: Once the Master Scheduler thread finds that the task instance is in the &quot;fault-tolerant&quot; state, it takes over the task and resubmits it.</p>
<p>Note: Due to &quot;network jitter&quot;, the node may lose its heartbeat with ZooKeeper in a short period of time, and the node's remove event may occur. For this situation, we use the simplest way, that is, once the node and ZooKeeper timeout connection occurs, then directly stop the Master or Worker service.</p>
<h6>2.Task failed and try again</h6>
<p>Here we must first distinguish the concepts of task failure retry, process failure recovery, and process failure rerun:</p>
<ul>
<li>Task failure retry is at the task level and is automatically performed by the scheduling system. For example, if a
Shell task is set to retry for 3 times, it will try to run it again up to 3 times after the Shell task fails.</li>
<li>Process failure recovery is at the process level and is performed manually. Recovery can only be performed <strong>from the
failed node</strong> or <strong>from the current node</strong></li>
<li>Process failure rerun is also at the process level and is performed manually, rerun is performed from the start node</li>
</ul>
<p>Next to the topic, we divide the task nodes in the workflow into two types.</p>
<ul>
<li>
<p>One is a business node, which corresponds to an actual script or processing statement, such as Shell node, MR node,
Spark node, and dependent node.</p>
</li>
<li>
<p>There is also a logical node, which does not do actual script or statement processing, but only logical processing of
the entire process flow, such as sub-process sections.</p>
</li>
</ul>
<p>Each <strong>business node</strong> can be configured with the number of failed retries. When the task node fails, it will
automatically retry until it succeeds or exceeds the configured number of retries. <strong>Logical node</strong> Failure retry is not
supported. But the tasks in the logical node support retry.</p>
<p>If there is a task failure in the workflow that reaches the maximum number of retries, the workflow will fail to stop,
and the failed workflow can be manually rerun or process recovery operation</p>
<h5>Five、Task priority design</h5>
<p>In the early scheduling design, if there is no priority design and the fair scheduling design is used, the task
submitted first may be completed at the same time as the task submitted later, and the process or task priority cannot
be set, so We have redesigned this, and our current design is as follows:</p>
<ul>
<li>According to <strong>priority of different process instances</strong> priority over <strong>priority of the same process instance</strong>
priority over <strong>priority of tasks within the same process</strong>priority over <strong>tasks within the same process</strong>submission
order from high to Low task processing.
<ul>
<li>
<p>The specific implementation is to parse the priority according to the JSON of the task instance, and then save
the <strong>process instance priority_process instance id_task priority_task id</strong> information in the ZooKeeper task
queue, when obtained from the task queue, pass String comparison can get the tasks that need to be executed first</p>
<ul>
<li>
<p>The priority of the process definition is to consider that some processes need to be processed before other
processes. This can be configured when the process is started or scheduled to start. There are 5 levels in
total, which are HIGHEST, HIGH, MEDIUM, LOW, and LOWEST. As shown below</p>
  <p align="center">
     <img src="https://analysys.github.io/easyscheduler_docs_cn/images/process_priority.png" alt="Process priority configuration"  width="40%" />
   </p>
</li>
<li>
<p>The priority of the task is also divided into 5 levels, followed by HIGHEST, HIGH, MEDIUM, LOW, LOWEST. As
shown below</p>
  <p align="center">
     <img src="https://analysys.github.io/easyscheduler_docs_cn/images/task_priority.png" alt="Task priority configuration"  width="35%" />
   </p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5>Six、Logback and netty implement log access</h5>
<ul>
<li>
<p>Since Web (UI) and Worker are not necessarily on the same machine, viewing the log cannot be like querying a local
file. There are two options:</p>
</li>
<li>
<p>Put logs on the ES search engine</p>
</li>
<li>
<p>Obtain remote log information through netty communication</p>
</li>
<li>
<p>In consideration of the lightness of DolphinScheduler as much as possible, so I chose gRPC to achieve remote access to
log information.</p>
</li>
</ul>
 <p align="center">
   <img src="https://analysys.github.io/easyscheduler_docs_cn/images/grpc.png" alt="grpc remote access"  width="50%" />
 </p>
<ul>
<li>We use the FileAppender and Filter functions of the custom Logback to realize that each task instance generates a log
file.</li>
<li>FileAppender is mainly implemented as follows：</li>
</ul>
<pre><code class="language-java"><span class="hljs-comment">/**
 * task log appender
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskLogAppender</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileAppender</span>&lt;<span class="hljs-title">ILoggingEvent</span>&gt; </span>{

    ...

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(ILoggingEvent event)</span> </span>{

       <span class="hljs-keyword">if</span> (currentlyActiveFile == <span class="hljs-keyword">null</span>){
           currentlyActiveFile = getFile();
       }
       String activeFile = currentlyActiveFile;
       <span class="hljs-comment">// thread name： taskThreadName-processDefineId_processInstanceId_taskInstanceId</span>
       String threadName = event.getThreadName();
       String[] threadNameArr = threadName.split(<span class="hljs-string">&quot;-&quot;</span>);
       <span class="hljs-comment">// logId = processDefineId_processInstanceId_taskInstanceId</span>
       String logId = threadNameArr[<span class="hljs-number">1</span>];
       ...
       <span class="hljs-keyword">super</span>.subAppend(event);
   }
}


Generate logs in the form of /process definition id/process instance id/task instance id.log

- Filter to match the thread name starting with TaskLogInfo:

- TaskLogFilter is implemented as follows：

```java
<span class="hljs-comment">/**
*  task log filter
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskLogFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Filter</span>&lt;<span class="hljs-title">ILoggingEvent</span>&gt; </span>{

   <span class="hljs-meta">@Override</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> FilterReply <span class="hljs-title">decide</span><span class="hljs-params">(ILoggingEvent event)</span> </span>{
       <span class="hljs-keyword">if</span> (event.getThreadName().startsWith(<span class="hljs-string">&quot;TaskLogInfo-&quot;</span>)){
           <span class="hljs-keyword">return</span> FilterReply.ACCEPT;
       }
       <span class="hljs-keyword">return</span> FilterReply.DENY;
   }
}

</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><div><h3>About us</h3><h4>Do you need feedback? Please contact us through the following ways.</h4></div><div class="contact-container"><ul><li><a href="/en-us/community/development/subscribe.html"><img class="img-base" src="/img/emailgray.png"/><img class="img-change" src="/img/emailblue.png"/><p>Email List</p></a></li><li><a href="https://twitter.com/dolphinschedule"><img class="img-base" src="/img/twittergray.png"/><img class="img-change" src="/img/twitterblue.png"/><p>Twitter</p></a></li><li><a href="https://stackoverflow.com/questions/tagged/apache-dolphinscheduler"><img class="img-base" src="/img/stackoverflow.png"/><img class="img-change" src="/img/stackoverflow-selected.png"/><p>Stack Overflow</p></a></li><li><a href="https://s.apache.org/dolphinscheduler-slack"><img class="img-base" src="/img/slack.png"/><img class="img-change" src="/img/slack-selected.png"/><p>Slack</p></a></li></ul></div><div class="cols-container"><div class="docu-container"><h4>Documentation</h4><ul><li><a href="/en-us/development/architecture-design.html"><p>Overview</p></a></li><li><a href="/en-us/docs/latest/user_doc/guide/quick-start.html"><p>Quick start</p></a></li><li><a href="/en-us/development/development-environment-setup.html"><p>Developer guide</p></a></li></ul></div><div></div><div class="asf-container"><h4>ASF</h4><ul><li><a href="http://www.apache.org"><p>Foundation</p></a></li><li><a href="http://www.apache.org/licenses/"><p>License</p></a></li><li><a href="http://www.apache.org/events/current-event"><p>Events</p></a></li><li><a href="http://www.apache.org/foundation/sponsorship.html"><p>Sponsorship</p></a></li><li><a href="http://www.apache.org/foundation/thanks.html"><p>Thanks</p></a></li></ul></div></div><div class="copyright"><span>Copyright © 2019-2021 The Apache Software Foundation. Apache DolphinScheduler, DolphinScheduler, and its feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
  <script src="/asset/js/react/react-with-addons.min.js"></script>
  <script src="/asset/js/react/react-dom.min.js"></script>
  <script>window.rootPath = '';</script>
  <script src="/build/vendor.36e600e.js"></script>
  <script src="/build/docs.md.f7ad2b7.js"></script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6bc736fd9885d9a5dc938425ac062ad";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-899J8PYKJZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-899J8PYKJZ');
  </script>
</body>
</html>