<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="keywords" content="Apache,DolphinScheduler,scheduler,big data,ETL,airflow,hadoop,orchestration,dataops,Meetup">
  <meta name="description" content="At XWBank, a large number of task instances are generated every day">
  <title>Three scenarios and five optimizations of Apache DolphinScheduler in XWBank for processing of task instances</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/build/vendor.eeae4ed.css">
  <link rel="stylesheet" href="/build/blog.md.055b3f1.css">
</head>
<body>
  <div id="root"><div class="blog-detail-page" data-reactroot=""><header class="header-container header-container-dark"><div class="banner-tips"><div>ðŸ¤” Have queries regarding Apache DolphinScheduler, Join Slack channel to disscuss them <a class="link-tips" href="https://s.apache.org/dolphinscheduler-slack">join #dolphinscheduler channel</a>! ðŸŒŸ</div></div><div class="header-body"><span class="mobile-menu-btn mobile-menu-btn-dark"></span><a href="/en-us/index.html"><img class="logo" src="/img/hlogo_white.svg"/></a><div class="search search-dark"><span class="icon-search"></span></div><span class="language-switch language-switch-dark">ä¸­</span><div class="header-menu"><div><ul class="ant-menu whiteClass ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/index.html" target="_self">HOME</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">DOCS</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/download/download.html" target="_self">DOWNLOAD</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item ant-menu-item-selected" role="menuitem"><a href="/en-us/blog/index.html" target="_self">BLOG</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/development/development-environment-setup.html" target="_self">DEVELOPMENT</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/community/team.html" target="_self">COMMUNITY</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper"><a href="https://www.apache.org/" target="_blank">ASF</a></span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/user/index.html" target="_self">USER</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>Â·Â·Â·</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></div></div><div class="mobile-menu"><div class="mobile-menu-content"><div class="mobile-menu-list"><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/index.html" target="_self">HOME</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">DOCS</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="/en-us/docs/latest/user_doc/about/introduction.html" target="_self">latest(3.0.0-beta-2)</a></div><div class="mobile-sub-menu-item"><a href="/en-us/docs/1.3.9/user_doc/quick-start.html" target="_self">1.3.9</a></div><div class="mobile-sub-menu-item"><a href="/en-us/docs/release/history-versions.html" target="_self">Older Versions</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/download/download.html" target="_self">DOWNLOAD</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/blog/index.html" target="_self">BLOG</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/development/development-environment-setup.html" target="_self">DEVELOPMENT</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/community/team.html" target="_self">COMMUNITY</a></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="https://www.apache.org/" target="_blank">ASF</a><em class="mobile-menu-icon"></em><div class="mobile-sub-menus"><div class="mobile-sub-menu-item"><a href="https://www.apache.org/" target="_blank">Foundation</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/licenses/" target="_blank">License</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/events/current-event" target="_blank">Events</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/security/" target="_blank">Security</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank">Sponsorship</a></div><div class="mobile-sub-menu-item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a></div></div></div><div class="mobile-menu-item"><a class="mobile-menu-title" href="/en-us/user/index.html" target="_self">USER</a></div></div></div><div class="mobile-menu-dummy"></div></div></div></header><section class="blog-content markdown-body"><h1>Three scenarios and five optimizations of Apache DolphinScheduler in XWBank for processing of task instances</h1>
<div align=center>
<img src="/img/2022-05-25/en/1.jpg"/>
</div>
<p>At XWBank, a large number of task instances are generated every day, with real-time tasks making up the majority. To better handle the task instances, XWBank chose Apache DolphinScheduler to solve this challenge after a comprehensive consideration. Today, several XWBank projects have applied real-time and quasi-real-time batch processing and offline batch processing for metrics management systems in three types of scenarios, i.e. offline data development and task scheduling, quasi-real-time data development and task scheduling, and other non-ETL user-defined data batch processing.</p>
<p>How did XWBank adapt the Apache DolphinScheduler to better suit its business needs? At the Apache DolphinScheduler Meetup in April, Chen Wei, Senior Big Data Engineer from the Big Data Center of XWBank, presented their practical Application of Apache DolphinScheduler in the company.</p>
<p>The sharing was divided into four sessions.</p>
<ul>
<li>
<ol>
<li>Background of the introduction of Apache DolphinScheduler in XWBank</li>
</ol>
</li>
<li>
<ol start="2">
<li>Application scenarios of Apache DolphinScheduler</li>
</ol>
</li>
<li>
<ol start="3">
<li>Optimization and transformation of XWBank</li>
</ol>
</li>
<li>
<ol start="4">
<li>The follow-up plan for XWBank to use Apache DolphinScheduler</li>
</ol>
</li>
</ul>
<div align=center>
<img src="/img/2022-05-25/en/2.png"/>
</div>
<p>Chen Wei</p>
<p>Senior Big Data Engineer, Big Data Center of XWBank</p>
<p>He has 11 years of working experience, earlier engaged in data warehouse construction, then focus on the construction of big data infrastructure platforms, scheduling system, etc. He has experience in the traditional financial industry, internet data warehouse, data mart construction, and many years of experience in scheduling system construction, such as MIGU analysis cloud scheduling system design, and report platform design, now mainly responsible for the construction of DataOps system of XWBank (offline development, indicator system, tagging system).</p>
<h2>01 Background</h2>
<p>We chose Apache DolphinScheduler based on three main requirements: unification of R&amp;D scenarios, optimization of testing scenarios, and optimization of production deployment scenarios.</p>
<h3>01 R&amp;D scenarios</h3>
<p>In the past, we did not have a unified development tool in the data development process, so we needed to switch back and forth between multiple tools, resulting in excessive development costs.</p>
<p>On the other hand, we were unable to replace parameters during development, could not perform on-the-fly debugging, and had no off-the-shelf tools to support offline tasks in both development and production states.</p>
<h3>02 Test scenarios</h3>
<p>During the deployment of test scenarios, when our developers provide scripts to the tests, the documentation returned is rather unfriendly. Especially when multiple scenarios are deployed across multiple versions, the testersâ€™ tasks increase dramatically and the visual deployment is relatively weak, making it impossible to automate tests in a more friendly way.</p>
<h3>03 Deployment</h3>
<p>Complex configuration and poor visualization of the current scheduling system.
The development and production environment networks are physically isolated, so the process of deploying code from the development environment to the production environment is long and error-prone. The test environment does not fully reflect the configuration of the production environment, and manual configuration files are prone to errors and omissions.
Insufficient operation and maintenance monitoring capabilities, poor visualization, inability to view logs online, and complex process of logging into the physical machine to access the monitoring room for troubleshooting.</p>
<h2>02 Usage scenarios</h2>
<p>We use Apache DolphinScheduler in the following scenarios: offline data development and task scheduling, quasi real-time data development and task scheduling, and other non-ETL user-defined data batch processing.</p>
<h3>01 Offline Data Development and Task Scheduling</h3>
<p>In offline data development and task scheduling.
we mainly use it for our banking data warehouse, data mart, etc. The data includes some offline data, offline processed data by day and month, etc.</p>
<h3>02 Quasi-real-time data development and task scheduling</h3>
<p>The quasi-real-time data in XWBank is fused and calculated by Flink from the logs of the upstream message queue database, completing the relevant dimensional information and then pushing the data to Clickhouse for processing. However, there are special requirements for batch calculations on a minute-by-minute basis, as opposed to daily batch scheduling.</p>
<h3>03 Other non-ETL user-defined data batch processing</h3>
<p>This application is functionally deployed through some internal low-code platform where we open up the application to a servicer who can self-analyze the use data without the need for developersâ€™ help. After defining, they can run this part of the data in batches on their own.</p>
<h3>1. Offline data mining and task scheduling</h3>
<p>We use Apache DolphinScheduler in the offline data mining and task scheduling scenario, which mainly involves five sections: task development modulation, historical task integration, workflow and task separation, project environment variables, and data source finding.</p>
<p>1.Task development modulation (SQL, SHELL, PYTHON, XSQL, etc.), online development modulation (under view logs, online log . online SQL query return results view). WEBIDE can automatically replace pop-up variables, and dynamically replace variables according to the userâ€™s settings and default processing.</p>
<p>2.Historical tasks integration</p>
<p>Most of the warehouses in the banking industry have been established for four or five years and have a lot of historical tasks. Therefore, we do not want our users to need to change the code independently when our new system goes online, which costs relatively high.</p>
<p>3.Workflow and task separation</p>
<p>Allows for direct tasks development, debugging, and testing and the workflow directly references the developed tasks, thus separate task development and task scheduling.</p>
<p>4.Project environment variables</p>
<p>New project environment variables are added, and project environment variables are adapted to all jobs within the project by default, saving us from configuring them within each workflow, and each project can refer to them directly.</p>
<p>5.Data sources</p>
<p>We look for data sources by name, and it supports data sources such as phoenix. Later we want it to be able to import and export tasks, but in the process of importing and exporting, the definition of parameters and data sources in our tasks cannot be changed, so that they can be directed from testing to production, which is simpler in terms of production.</p>
<h3>2. Quasi-real-time tasks</h3>
<ol>
<li>
<p>Task development modulation (SQL), online development modulation (online view of logs, online view of SQL query return results), pop-up windows in WEBIDE to replace script variables.</p>
</li>
<li>
<p>Clickhouse data source HA configuration integration support. However, there is a small problem in batch processing offline, i.e. if the current port is not available, an error may be reported directly. This is a problem that needs a fix.</p>
</li>
<li>
<p>For quasi-real-time workflow single instance running, if there is already an initialized instance, or there is an ongoing workflow instance, the workflow will not be triggered to run even if the next batch is triggered.</p>
</li>
</ol>
<h3>3. Other non-ETL user-defined data batch processing</h3>
<ol>
<li>
<p>We currently have model data calculation tasks pushed from the metrics management platform. The simple user-defined reports will generate SQL dynamically by the platform and subsequently pushed directly to offline scheduling. This process will not involve any developer in the future.</p>
</li>
<li>
<p>In the tag management system, we mainly adapt it to scenario needs by generating special plug-in tasks.</p>
</li>
</ol>
<h2>03 Optimisation</h2>
<h3>1.The status</h3>
<p>In XWBank, there are about 9000+ task instances generated every day, with real-time tasks making up the majority. Today, we have used Apache DolphinScheduler to run batches in real-time and quasi-real-time tasks for many projects, offline batches for the metrics management system, including batches for the integrated internal SQL tools that support XSQL.</p>
<div align=center>
<img src="/img/2022-05-25/en/3.jfif"/>
</div>
<p>In the picture above on the right, we can see that we have made tasks independent, replacing parameters. Also, in terms of task lineage, especially for SQL-type tasks, we can do automatic parsing and also add them manually. This is mainly used for the automatic orchestration of our workflows, such as the internal task maps of the company.</p>
<p>To meet the above business requirements, we have made the following five major optimizations to Apache DolphinScheduler and also listed the corresponding modifications that must be noted during the transformation process.</p>
<ol>
<li>Environment variables are isolated from projects, and environments, but the names of environment variables are kept consistent across environments.</li>
<li>Data sources are isolated through the project, and the environment, but the names of the data sources remain consistent across the different environments.</li>
<li>New non-JDBC data sources are added, like ES, Livy, etc. In internal transparent applications, Livy is needed as a data service framework to interface with Spark jobs for data desensitization.</li>
</ol>
<h3>2. Standalone jobs</h3>
<ul>
<li>Develop standalone task development, debugging, configuration pages, able to support project environment variables</li>
<li>JDBC, XSQL tasks can refer to data sources by data source name</li>
<li>Implement interactive WEBIDE debugging and development</li>
<li>Parameter optimization, support for user ${parameter} and referencing of system built-in time functions</li>
<li>Completion of independent SQL, XQSL automatic lineage parsing</li>
<li>Complete automatic SQL parameter parsing</li>
</ul>
<h3>3. Optimization of workflow startup logic</h3>
<ul>
<li>Quasi-real-time workflow single instance run, if there is already a running workflow instance, this run will be ignored.</li>
<li>Adding environment control policies, where workflows refer to different environment variables, and data source access connections, depending on the environment. For example, if the disaster recovery environment and the production environment are configured in advance, once an error occurs in the production environment, it can be switched to the disaster recovery environment with one click.</li>
<li>Solve scheduling problems caused by workflow and task separation, mainly including the detection of exceptions</li>
</ul>
<h3>4. Import and export optimization</h3>
<ul>
<li>New import and export of tasks, task configurations, and their resource files, etc.</li>
<li>In the banking and financial industries where the develope&amp;test and production networks are not always the same, there is a need to export a relatively friendly resource script workflow and resource file information when processing data in multiple environments.</li>
<li>New workflow import and export logic to deal with data conflicts due to self-incrementing IDs of different database instances</li>
<li>Navigated import and export, versioning, mainly for emergencies, partial code rollback, etc.</li>
</ul>
<h3>5. Alerting system improvement and optimization</h3>
<ul>
<li>Docking to the internal alert system of XWBank, default alerting of task creators subscribing to the alerting group users</li>
<li>Add policy alerts (start-up delay, completion delay) to alert key tasks for start-up and completion delay</li>
</ul>
<ol start="6">
<li>Interfacing with internal systems</li>
</ol>
<ul>
<li>Model-type task operation and monitoring</li>
<li>Report push-tasks operation and monitoring</li>
<li>Interfacing with internal IAM SSO unified login authentication system</li>
<li>Restrict specific functions (code editing, workflow running, task running, etc.) by the network</li>
</ul>
<p>There is a special phenomenon in the financial industry that the production needs to be done in a specific server room, i.e. we have to restrict certain operations to be done in the server room while reducing the cost of one change.</p>
<p>We create reports automatically based primarily on this dimensional model theory. Once configured, we perform a code merge calculation of multiple tables based on the configuration report logic. The aggregation calculation is completed and pushed to the report server. This allows business users to perform data aggregation without the need to write SQL following some of the basic functionality we provide, thus avoiding the business end-user being upset and giving us ad hoc requests.</p>
<h2>04 Future Plans</h2>
<ul>
<li>Promote the offline data development platform to more project teams</li>
<li>Gradually replace the existing scheduling system in the bank to achieve smooth migration of all offline tasks</li>
<li>Scheduling system will be sunk to connect to the bankâ€™s data R&amp;D management system</li>
</ul>
<h3>Technical objectives</h3>
<ol>
<li>A more intelligent and automated task scheduling system, lowering the threshold for the user</li>
<li>Operation monitoring and prediction, providing more friendly operation and maintenance monitoring and task completion time prediction functions for the operation and maintenance staff</li>
<li>Global view functionality, providing a global view of offline tasks for development, operations, and maintenance staff, providing data lineage and impact analysis functionality</li>
<li>Further integration with in-line custom configuration modularity to reduce development costs for developers</li>
<li>Integration with data quality management platforms</li>
<li>User-defined template support</li>
</ol>
<p>Thank you all, that's all I have to share today.</p>
</section><footer class="footer-container"><div class="footer-body"><div><h3>About us</h3><h4>Do you need feedback? Please contact us through the following ways.</h4></div><div class="contact-container"><ul><li><a href="/en-us/community/development/subscribe.html"><img class="img-base" src="/img/emailgray.png"/><img class="img-change" src="/img/emailblue.png"/><p>Email List</p></a></li><li><a href="https://twitter.com/dolphinschedule"><img class="img-base" src="/img/twittergray.png"/><img class="img-change" src="/img/twitterblue.png"/><p>Twitter</p></a></li><li><a href="https://stackoverflow.com/questions/tagged/apache-dolphinscheduler"><img class="img-base" src="/img/stackoverflow.png"/><img class="img-change" src="/img/stackoverflow-selected.png"/><p>Stack Overflow</p></a></li><li><a href="https://s.apache.org/dolphinscheduler-slack"><img class="img-base" src="/img/slack.png"/><img class="img-change" src="/img/slack-selected.png"/><p>Slack</p></a></li></ul></div><div class="cols-container"><div class="docu-container"><h4>Documentation</h4><ul><li><a href="/en-us/development/architecture-design.html"><p>Overview</p></a></li><li><a href="/en-us/docs/latest/user_doc/guide/quick-start.html"><p>Quick start</p></a></li><li><a href="/en-us/development/development-environment-setup.html"><p>Developer guide</p></a></li></ul></div><div></div><div class="asf-container"><h4>ASF</h4><ul><li><a href="http://www.apache.org"><p>Foundation</p></a></li><li><a href="http://www.apache.org/licenses/"><p>License</p></a></li><li><a href="http://www.apache.org/events/current-event"><p>Events</p></a></li><li><a href="http://www.apache.org/foundation/sponsorship.html"><p>Sponsorship</p></a></li><li><a href="http://www.apache.org/foundation/thanks.html"><p>Thanks</p></a></li></ul></div></div><div class="copyright"><span>Copyright Â© 2019-2021 The Apache Software Foundation. Apache DolphinScheduler, DolphinScheduler, and its feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
  <script src="/asset/js/react/react-with-addons.min.js"></script>
  <script src="/asset/js/react/react-dom.min.js"></script>
  <script>window.rootPath = '';</script>
  <script src="/build/vendor.a476297.js"></script>
  <script src="/build/blog.md.f25cabd.js"></script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d6bc736fd9885d9a5dc938425ac062ad";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-899J8PYKJZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-899J8PYKJZ');
  </script>
</body>
</html>